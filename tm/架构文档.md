# 天猫爬虫系统 - 架构文档

## 📋 文档说明

**本文档目的：**
- 快速了解天猫爬虫系统的功能和使用方式
- 新增爬虫时的操作指南
- 维护和故障排查

**最后更新：** 2025-10-04

---

## 🏗️ 系统架构

### 核心设计理念

**任务生成与执行分离**
- ✅ 任务生成：由 `D:\testyd\task_generator` 统一生成所有平台任务
- ✅ 任务执行：各爬虫脚本只负责执行任务并更新状态
- ✅ 统一调度：由 `task_generator` 统一调度所有任务

### 架构流程

```
1. 任务生成（统一）
   ↓
   D:\testyd\task_generator\generate_all_tasks.py
   - 每天00:05自动为所有平台生成任务
   - 在tm_tasks表中创建记录，状态为"待执行"
   ↓
2. 任务执行（各爬虫）
   ↓
   tm_badscore.py / tm_chat.py / tm_kpi.py
   - 从tm_tasks表读取"待执行"任务
   - 执行数据采集
   - 更新状态为"已完成"
   ↓
3. 数据上传
   ↓
   - 合并Excel文件
   - 转换为Parquet格式
   - 上传到MinIO
   - 刷新Dremio表
```

---

## 📁 文件结构

```
tm_new/
├── 架构文档.md                # 本文档
├── crawler_config.py          # 爬虫配置文件（待创建）
├── get_tm_cookies.py          # Cookie获取工具
├── cookie_optimizer.py        # Cookie优化器
├── tm_badscore.py            # 差评数据采集
├── tm_chat.py                # 聊天数据采集
├── tm_kpi.py                 # KPI数据采集
├── tm_kpi_weekly.py          # KPI周报采集（待实现）
├── tm_kpi_monthly.py         # KPI月报采集（待实现）
└── README.md                 # 使用说明
```

---

## 📊 数据库表结构

### tm_shops 表（店铺信息）

| 字段 | 类型 | 说明 |
|------|------|------|
| shop_name | VARCHAR | 店铺名称（主键） |
| qncookie | TEXT | 千牛Cookie |
| sycmcookie | TEXT | 生意参谋Cookie |
| userNick | VARCHAR | 用户昵称 |
| reportTemplateId | VARCHAR | 报表模板ID |
| profile | VARCHAR | 浏览器配置文件 |

### tm_tasks 表（任务记录）

| 字段 | 类型 | 说明 |
|------|------|------|
| time_period | DATE | 时间周期（主键） |
| shop_name | VARCHAR | 店铺名称（主键） |
| badscore_status | VARCHAR | 差评任务状态 |
| chat_status | VARCHAR | 聊天任务状态 |
| kpi_self_status | VARCHAR | KPI自制报表任务状态 |
| kpi_official_status | VARCHAR | KPI官方报表任务状态 |
| kpi_weekly_status | VARCHAR | KPI周报任务状态 |
| kpi_monthly_status | VARCHAR | KPI月报任务状态 |

**任务状态值：**
- `NULL` - 无任务
- `待执行` - 任务已生成，等待执行
- `已完成` - 任务已完成

---

## 🚀 核心爬虫说明

### 1. tm_badscore.py - 差评数据采集

**功能：** 采集天猫店铺的差评数据

**日期偏移：** T-1（昨天）

**使用方式：**
```bash
cd D:\testyd\tm_new
python tm_badscore.py
```

**执行流程：**
1. 从tm_tasks表读取badscore_status="待执行"的任务
2. 遍历每个店铺，调用API获取差评数据
3. 保存为Excel文件
4. 更新任务状态为"已完成"
5. 合并所有文件并上传到MinIO

**API接口：** `https://h5api.m.taobao.com/h5/mtop.rm.sellercenter.list.data.pc/1.0/`

---

### 2. tm_chat.py - 聊天数据采集

**功能：** 采集天猫店铺的客服聊天记录

**日期偏移：** T-1（昨天）

**使用方式：**
```bash
cd D:\testyd\tm_new
python tm_chat.py
```

**执行流程：**
1. 从tm_tasks表读取chat_status="待执行"的任务
2. 遍历每个店铺，获取客户列表
3. 获取每个客户的聊天记录
4. 保存为Excel文件
5. 更新任务状态为"已完成"
6. 合并所有文件并上传到MinIO

**API接口：**
- 客户列表：`https://h5api.m.taobao.com/h5/mtop.taobao.wireless.amp2.paas.conversation.list/1.0/`
- 聊天记录：`https://h5api.m.taobao.com/h5/mtop.taobao.wireless.amp2.im.paas.message.list/1.0/`

**特点：** 支持并发处理，最大6个线程同时处理店铺

---

### 3. tm_kpi.py - KPI数据采集

**功能：** 采集天猫店铺的客服绩效数据

**日期偏移：** T-4（4天前）

**使用方式：**
```bash
cd D:\testyd\tm_new
python tm_kpi.py
```

**执行流程：**
1. 从tm_tasks表读取kpi_self_status="待执行"的任务
2. 获取自制报表数据
3. 更新任务状态为"已完成"
4. 从tm_tasks表读取kpi_official_status="待执行"的任务
5. 获取官方报表数据
6. 更新任务状态为"已完成"
7. 分别合并并上传到MinIO

**API接口：**
- 自制报表：`https://sycm.taobao.com/custom/report/download`
- 官方报表：`https://sycm.taobao.com/custom/report/download`

---

## 🔧 Cookie获取工具

### get_tm_cookies.py

**功能：** 自动获取天猫店铺的Cookie

**使用方式：**
```bash
cd D:\testyd\tm_new
python get_tm_cookies.py
```

**执行流程：**
1. 从tm_shops表读取所有店铺
2. 使用Playwright启动浏览器
3. 加载店铺的浏览器配置文件
4. 访问千牛和生意参谋页面
5. 提取Cookie
6. 更新到tm_shops表

**特点：**
- 支持多店铺批量获取
- 自动重试机制（最多3次）
- Cookie优化（移除无用字段）
- 使用持久化浏览器上下文

---

## 📝 任务生成与执行流程

### 任务生成（统一）

**位置：** `D:\testyd\task_generator\generate_all_tasks.py`

**执行时间：** 每天00:05自动执行

**手动执行：**
```bash
cd D:\testyd\task_generator
python generate_all_tasks.py --schedule daily --platforms tm
```

**生成逻辑：**
1. 读取tm_shops表获取所有店铺
2. 根据配置计算目标日期（如T-1、T-4）
3. 在tm_tasks表中创建记录（如果不存在）
4. 设置对应任务状态字段为"待执行"

### 任务执行（各爬虫）

**执行时间：** 由调度系统自动执行

**手动执行：**
```bash
cd D:\testyd\tm_new
python tm_badscore.py  # 差评数据
python tm_chat.py      # 聊天数据
python tm_kpi.py       # KPI数据
```

**执行逻辑：**
1. 从tm_tasks表读取"待执行"任务
2. 遍历每个店铺执行数据采集
3. 采集成功后更新状态为"已完成"
4. 合并文件并上传到MinIO

---

## 🔄 调度配置

**位置：** `D:\testyd\task_generator\platform_config.py`

**天猫任务配置：**

| 任务 | 调度类型 | 日期偏移 | 执行时间 | 状态字段 |
|------|---------|---------|---------|---------|
| 差评数据 | daily | T-1 | 08:30 | badscore_status |
| 聊天数据 | daily | T-1 | 09:00 | chat_status |
| KPI自制报表 | daily | T-4 | 10:00 | kpi_self_status |
| KPI官方报表 | daily | T-4 | 10:00 | kpi_official_status |
| KPI周报 | weekly | T-9~T-3 | 周六12:00 | kpi_weekly_status |
| KPI月报 | monthly | 上月 | 3号12:30 | kpi_monthly_status |

---

## 🛠️ 常用操作

### 1. 查看待执行任务

```sql
SELECT time_period, shop_name, 
       badscore_status, chat_status, 
       kpi_self_status, kpi_official_status
FROM tm_tasks
WHERE badscore_status = '待执行' 
   OR chat_status = '待执行'
   OR kpi_self_status = '待执行'
   OR kpi_official_status = '待执行';
```

### 2. 重置任务状态

```sql
-- 重置某个日期的差评任务
UPDATE tm_tasks 
SET badscore_status = '待执行' 
WHERE time_period = '2025-10-03';

-- 重置某个店铺的所有任务
UPDATE tm_tasks 
SET badscore_status = '待执行',
    chat_status = '待执行',
    kpi_self_status = '待执行'
WHERE shop_name = '店铺名称';
```

### 3. 手动生成任务

```bash
cd D:\testyd\task_generator
python generate_all_tasks.py --schedule daily --platforms tm --date 2025-10-03
```

### 4. 更新Cookie

```bash
cd D:\testyd\tm_new
python get_tm_cookies.py
```

---

## 📚 相关文档

- **统一任务管理系统**: `D:\testyd\task_generator\README.md`
- **调度系统文档**: `D:\testyd\task_generator\调度系统文档.md`
- **PDD架构文档**: `D:\testyd\pdd\架构文档.md`

---

## ⚠️ 重要说明

1. **任务生成统一管理** - 不要在各爬虫脚本中单独生成任务
2. **状态更新及时** - 任务完成后必须更新状态为"已完成"
3. **Cookie定期更新** - Cookie过期会导致采集失败
4. **日期偏移注意** - 不同任务的日期偏移不同，注意配置

---

**维护者：** AI Assistant  
**最后更新：** 2025-10-04  
**版本：** 1.0.0

