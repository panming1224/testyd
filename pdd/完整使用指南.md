# 拼多多爬虫系统 - 完整使用指南

## 📋 系统概述

这是一个基于配置驱动的拼多多数据采集系统，支持：
- ✅ 差评数据采集（T-1，昨天）
- ✅ 产品质量数据采集（T，今天）
- ✅ 客服绩效数据采集（T-3，3天前）
- ✅ 自动上传MinIO
- ✅ 自动刷新Dremio
- ✅ 精确的任务状态管理（UPDATE WHERE控制）
- ✅ 124家店铺完整测试通过

## 📁 文件结构

```
testyd/pdd/
├── crawler_config.py           # 配置文件（新增爬虫只需修改这里）
├── generate_tasks.py           # 任务生成器
├── base_crawler.py             # 爬虫基类
├── pdd_badscore.py            # 差评数据采集
├── pdd_quality.py             # 产品质量数据采集
├── pdd_kpi.py                 # 客服绩效数据采集（日度）
├── pdd_kpi_weekly.py          # 客服绩效数据采集（周度）- 待实现
├── pdd_kpi_monthly.py         # 客服绩效数据采集（月度）- 待实现
├── README.md                  # 项目说明
├── README_新架构使用指南.md   # 新架构详细文档
└── 新架构总结.md              # 架构设计总结
```

## 🚀 快速开始

### 1. 每日执行流程

```bash
# 步骤1: 生成每日任务
python testyd/pdd/generate_tasks.py --schedule daily

# 步骤2: 执行爬虫程序
python testyd/pdd/pdd_badscore.py    # 差评数据（T-1）
python testyd/pdd/pdd_quality.py     # 产品质量（T）
python testyd/pdd/pdd_kpi.py         # 客服绩效（T-3）
```

### 2. 指定日期执行

```bash
# 生成指定日期的任务
python testyd/pdd/generate_tasks.py --schedule daily --date 2025-10-02

# 执行爬虫程序（会自动根据配置计算目标日期）
python testyd/pdd/pdd_badscore.py
python testyd/pdd/pdd_quality.py
python testyd/pdd/pdd_kpi.py
```

## 📊 任务状态说明

数据库 `pdd_tasks` 表中的状态字段：

| 状态值 | 含义 | 说明 |
|--------|------|------|
| NULL | 无任务 | 该店铺该日期不需要执行此任务 |
| "待执行" | 待处理 | 任务已生成，等待执行 |
| "已完成" | 已完成 | 任务执行成功 |

### 核心设计理念

**精确的任务状态管理：**
- 使用 `INSERT IGNORE` + `UPDATE WHERE` 精确控制每个任务字段
- 不同任务类型的状态字段完全独立
- 例如：`2025-10-02` 只有 `badsscore_status='待执行'`，其他字段为NULL
- 这样可以确保不同任务类型在不同日期独立执行，互不影响

**示例：**
```
日期         店铺          差评状态    质量状态    绩效状态
2025-10-02  361南宸专卖店  待执行      NULL       NULL
2025-10-03  361南宸专卖店  NULL       待执行      NULL
2025-09-30  361南宸专卖店  NULL       NULL       待执行
```

## 🔧 配置说明

### crawler_config.py 配置项

```python
CRAWLER_TASKS = {
    'task_key': {
        'name': '任务名称',
        'script': '脚本文件名.py',
        'status_field': '数据库状态字段名',
        'schedule': 'daily/weekly/monthly',
        'date_offset': -1,  # 日期偏移（-1表示T-1）
        'minio_path': 'MinIO路径',
        'dremio_table': 'Dremio表路径',
        'enabled': True/False
    }
}
```

### 日期偏移说明

- `date_offset: 0` - T（今天）
- `date_offset: -1` - T-1（昨天）
- `date_offset: -3` - T-3（3天前）

## ➕ 新增爬虫步骤

### 步骤1: 添加配置

在 `crawler_config.py` 中添加：

```python
'new_task': {
    'name': '新任务名称',
    'script': 'pdd_new_task.py',
    'status_field': 'new_task_status',
    'schedule': 'daily',
    'date_offset': -1,
    'minio_path': 'ods/pdd/pdd_new_task',
    'dremio_table': 'minio.warehouse.ods.pdd.pdd_new_task',
    'enabled': True
}
```

### 步骤2: 添加数据库字段

```sql
ALTER TABLE pdd_tasks 
ADD COLUMN new_task_status VARCHAR(20) DEFAULT NULL;
```

### 步骤3: 创建爬虫脚本

参考 `pdd_badscore.py` 或 `pdd_quality.py` 的模式创建新脚本。

**完成！** 无需修改任何核心代码。

## 📝 数据库表结构

### pdd_shops 表

存储店铺信息，包括：
- shop_name: 店铺名称
- cookie: 登录凭证（索引11）
- 其他店铺信息...

### pdd_tasks 表

存储任务记录，主键：`(time_period, shop_name)`

字段：
- time_period: 时间周期（日期）
- shop_name: 店铺名称
- badsscore_status: 差评数据状态
- quality_status: 产品质量状态
- kpi_days_status: 客服绩效（日度）状态
- kpi_weekly_status: 客服绩效（周度）状态
- kpi_monthly_status: 客服绩效（月度）状态

## 🔍 常见问题

### Q1: 如何重新执行失败的任务？

失败的任务状态会保持"待执行"，直接重新运行爬虫程序即可：

```bash
python testyd/pdd/pdd_badscore.py
```

### Q2: 如何查看任务状态？

```bash
python testyd/check_task_status.py
```

### Q3: 如何清理测试数据？

```sql
DELETE FROM pdd_tasks WHERE time_period = '2025-10-02';
```

### Q4: 乱码问题如何解决？

程序已经设置了UTF-8编码，乱码是PowerShell显示问题，不影响实际功能。
如需查看正确输出，可以：
1. 使用 `cmd` 而不是 PowerShell
2. 或者设置PowerShell编码：`[Console]::OutputEncoding = [System.Text.Encoding]::UTF8`

### Q5: MinIO上传失败怎么办？

检查：
1. MinIO服务是否运行
2. 配置文件中的MinIO地址和凭证是否正确
3. 网络连接是否正常

### Q6: Dremio刷新失败怎么办？

检查：
1. Dremio服务是否运行
2. Dremio API地址是否正确
3. 数据集路径是否存在

## 🎯 最佳实践

### 1. 定时任务设置

建议使用Windows任务计划程序或Linux cron设置定时任务：

**每天早上8点执行：**
```bash
# 1. 生成任务
python D:\testyd\pdd\generate_tasks.py --schedule daily

# 2. 执行爬虫（间隔5分钟）
python D:\testyd\pdd\pdd_badscore.py
python D:\testyd\pdd\pdd_quality.py
python D:\testyd\pdd\pdd_kpi.py
```

### 2. 日志管理

建议将输出重定向到日志文件：

```bash
python testyd/pdd/pdd_badscore.py >> logs/badscore_$(date +%Y%m%d).log 2>&1
```

### 3. 错误监控

建议添加错误通知机制：
- 邮件通知
- 钉钉/企业微信通知
- 短信通知

### 4. 数据备份

建议定期备份：
- 数据库（pdd_tasks表）
- MinIO数据
- 本地Excel文件

## 📞 技术支持

如有问题，请查看：
1. `README_新架构使用指南.md` - 详细技术文档
2. `新架构总结.md` - 架构设计说明
3. 代码注释

## 🎉 总结

这个系统的核心优势：
- ✅ **配置驱动** - 新增爬虫只需修改配置
- ✅ **状态管理** - 清晰的任务状态跟踪
- ✅ **失败重试** - 失败任务自动保留待执行状态
- ✅ **代码复用** - 通用功能封装在基类中
- ✅ **易于维护** - 结构清晰，文档完善

**开始使用吧！** 🚀

