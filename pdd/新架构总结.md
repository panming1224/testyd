# æ‹¼å¤šå¤šçˆ¬è™«ç³»ç»Ÿ - æ–°æ¶æ„æ€»ç»“

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### é—®é¢˜èƒŒæ™¯

ä½ æå‡ºçš„æ ¸å¿ƒéœ€æ±‚ï¼š
1. **ä»»åŠ¡çŠ¶æ€è¦åŒºåˆ†"ç©ºå€¼"å’Œ"å¾…æ‰§è¡Œ"**
   - ç©ºå€¼ï¼ˆNULLï¼‰= æš‚æ—¶æ²¡æœ‰ä»»åŠ¡
   - "å¾…æ‰§è¡Œ" = æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œ
   - "å·²å®Œæˆ" = ä»»åŠ¡å·²å®Œæˆ

2. **ä¸åŒä»»åŠ¡ç±»å‹æœ‰ä¸åŒçš„æ‰§è¡Œé¢‘ç‡**
   - æ—¥åº¦ä»»åŠ¡ï¼šæ¯å¤©æ‰§è¡Œï¼ˆå·®è¯„ã€äº§å“è´¨é‡ã€å®¢æœç»©æ•ˆæ—¥åº¦ï¼‰
   - å‘¨åº¦ä»»åŠ¡ï¼šæ¯å‘¨æ‰§è¡Œï¼ˆå®¢æœç»©æ•ˆå‘¨åº¦ï¼‰
   - æœˆåº¦ä»»åŠ¡ï¼šæ¯æœˆæ‰§è¡Œï¼ˆå®¢æœç»©æ•ˆæœˆåº¦ï¼‰

3. **æ–°å¢çˆ¬è™«è¦ç®€å•**
   - åªéœ€æ·»åŠ å›ºå®šæ¨¡å—
   - ä¸éœ€è¦ä¿®æ”¹æ ¸å¿ƒä»£ç 

### è§£å†³æ–¹æ¡ˆ

é‡‡ç”¨**é…ç½®é©±åŠ¨ + åŸºç±»ç»§æ‰¿**çš„æ¶æ„ï¼š

```
é…ç½®æ–‡ä»¶ (crawler_config.py)
    â†“
ä»»åŠ¡ç”Ÿæˆå™¨ (generate_tasks.py)
    â†“
æ•°æ®åº“ (pdd_tasksè¡¨)
    â†“
çˆ¬è™«ç¨‹åº (ç»§æ‰¿BaseCrawler)
    â†“
æ•°æ®å¤„ç† (åˆå¹¶ã€ä¸Šä¼ ã€åˆ·æ–°)
```

## ğŸ“ æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

### 1. crawler_config.py - é…ç½®ä¸­å¿ƒ

**ä½œç”¨ï¼š** é›†ä¸­ç®¡ç†æ‰€æœ‰çˆ¬è™«çš„é…ç½®

**å†…å®¹ï¼š**
```python
CRAWLER_TASKS = {
    'badscore': {
        'name': 'å·®è¯„æ•°æ®é‡‡é›†',
        'status_field': 'badsscore_status',
        'schedule': 'daily',
        'date_offset': -1,
        'minio_path': 'ods/pdd/pdd_badscore',
        'dremio_table': 'minio.warehouse.ods.pdd.pdd_badscore',
        'enabled': True
    },
    # ... æ›´å¤šä»»åŠ¡é…ç½®
}
```

**ä¼˜åŠ¿ï¼š**
- æ‰€æœ‰é…ç½®é›†ä¸­ç®¡ç†
- ä¿®æ”¹é…ç½®æ— éœ€æ”¹ä»£ç 
- æ–°å¢ä»»åŠ¡åªéœ€æ·»åŠ é…ç½®

### 2. generate_tasks.py - ç»Ÿä¸€ä»»åŠ¡ç”Ÿæˆå™¨

**ä½œç”¨ï¼š** æ ¹æ®é…ç½®è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰ç±»å‹çš„ä»»åŠ¡

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
# ç”Ÿæˆæ¯æ—¥ä»»åŠ¡
python testyd/pdd/generate_tasks.py --schedule daily

# ç”Ÿæˆæ¯å‘¨ä»»åŠ¡
python testyd/pdd/generate_tasks.py --schedule weekly

# ç”Ÿæˆæ‰€æœ‰ä»»åŠ¡
python testyd/pdd/generate_tasks.py --schedule all
```

**æ ¸å¿ƒé€»è¾‘ï¼š**
1. è¯»å–é…ç½®æ–‡ä»¶
2. ç­›é€‰ç¬¦åˆè°ƒåº¦ç±»å‹çš„ä»»åŠ¡
3. ä¸ºæ¯ä¸ªä»»åŠ¡è°ƒç”¨æ•°æ®åº“æ¥å£ç”Ÿæˆä»»åŠ¡è®°å½•
4. ä½¿ç”¨ `INSERT ... ON DUPLICATE KEY UPDATE` ç¡®ä¿ï¼š
   - æ–°è®°å½•ï¼šæ’å…¥ï¼ŒçŠ¶æ€ä¸º"å¾…æ‰§è¡Œ"
   - å·²å­˜åœ¨è®°å½•ï¼šåªæ›´æ–°NULLå­—æ®µä¸º"å¾…æ‰§è¡Œ"ï¼Œå·²å®Œæˆçš„ä¸å˜

### 3. base_crawler.py - çˆ¬è™«åŸºç±»

**ä½œç”¨ï¼š** æä¾›æ‰€æœ‰çˆ¬è™«çš„é€šç”¨åŠŸèƒ½

**åŠŸèƒ½æ¨¡å—ï¼š**
- âœ… è·å–å¾…å¤„ç†ä»»åŠ¡
- âœ… æ›´æ–°ä»»åŠ¡çŠ¶æ€
- âœ… æ–‡ä»¶åˆå¹¶
- âœ… MinIOä¸Šä¼ 
- âœ… Dremioåˆ·æ–°

**å­ç±»åªéœ€å®ç°ï¼š**
```python
def process_shop(self, shop_name, cookie, **kwargs):
    """å¤„ç†å•ä¸ªåº—é“ºçš„æ•°æ®é‡‡é›†"""
    # 1. è°ƒç”¨APIè·å–æ•°æ®
    # 2. ä¿å­˜åˆ°Excel
    # 3. è¿”å›æ–‡ä»¶è·¯å¾„
```

### 4. crawler_db_interface.py - æ•°æ®åº“æ¥å£

**æ ¸å¿ƒæ–¹æ³•ï¼š**

#### generate_tasks()
```python
def generate_tasks(self, time_period: str, task_columns: List[str]) -> int:
    """
    ä¸ºæ‰€æœ‰åº—é“ºç”ŸæˆæŒ‡å®šæ—¶é—´å‘¨æœŸçš„ä»»åŠ¡
    
    ç­–ç•¥ï¼š
    1. INSERTæ—¶åªè®¾ç½®æŒ‡å®šçš„ä»»åŠ¡å­—æ®µä¸º"å¾…æ‰§è¡Œ"
    2. å¦‚æœè®°å½•å·²å­˜åœ¨ï¼Œåªæ›´æ–°æŒ‡å®šçš„ä»»åŠ¡å­—æ®µï¼ˆå¦‚æœæ˜¯NULLåˆ™è®¾ä¸º"å¾…æ‰§è¡Œ"ï¼‰
    3. å·²å®Œæˆçš„ä»»åŠ¡ä¸ä¼šè¢«é‡ç½®
    """
```

**SQLé€»è¾‘ï¼š**
```sql
INSERT INTO pdd_tasks (time_period, shop_name, badsscore_status) 
VALUES ('2025-10-02', '361å—å®ä¸“å–åº—', 'å¾…æ‰§è¡Œ')
ON DUPLICATE KEY UPDATE 
    badsscore_status = IF(badsscore_status IS NULL OR badsscore_status = '', 'å¾…æ‰§è¡Œ', badsscore_status)
```

#### get_pending_tasks()
```python
def get_pending_tasks(self, time_period: str, task_column: str) -> List:
    """
    è·å–æŒ‡å®šæ—¶é—´å‘¨æœŸå’Œä»»åŠ¡ç±»å‹çš„å¾…å¤„ç†ä»»åŠ¡
    
    æŸ¥è¯¢æ¡ä»¶ï¼šstatus = 'å¾…æ‰§è¡Œ'
    """
```

**SQLé€»è¾‘ï¼š**
```sql
SELECT dt.time_period, dt.shop_name, s.*
FROM pdd_tasks dt
JOIN pdd_shops s ON dt.shop_name = s.shop_name
WHERE dt.time_period = '2025-10-02' 
  AND dt.badsscore_status = 'å¾…æ‰§è¡Œ'
```

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### æ¯æ—¥æ‰§è¡Œæµç¨‹

```
1. ç”Ÿæˆä»»åŠ¡ï¼ˆæ¯å¤©æœ€å…ˆæ‰§è¡Œï¼‰
   python testyd/pdd/generate_tasks.py --schedule daily
   â†“
   ä¸ºæ‰€æœ‰åº—é“ºåˆ›å»º/æ›´æ–°ä»»åŠ¡è®°å½•
   - badsscore_status = 'å¾…æ‰§è¡Œ'
   - quality_status = 'å¾…æ‰§è¡Œ'
   - kpi_days_status = 'å¾…æ‰§è¡Œ'

2. æ‰§è¡Œçˆ¬è™«ç¨‹åº
   python testyd/pdd/pdd_badscore.py
   â†“
   - æŸ¥è¯¢ badsscore_status = 'å¾…æ‰§è¡Œ' çš„ä»»åŠ¡
   - é€ä¸ªå¤„ç†åº—é“ºæ•°æ®
   - æˆåŠŸåæ›´æ–°çŠ¶æ€ä¸º 'å·²å®Œæˆ'
   - å¤±è´¥ä¿æŒ 'å¾…æ‰§è¡Œ' çŠ¶æ€

3. ç»§ç»­æ‰§è¡Œå…¶ä»–çˆ¬è™«
   python testyd/pdd/pdd_quality.py
   python testyd/pdd/pdd_kpi.py
```

### å‘¨åº¦/æœˆåº¦æ‰§è¡Œæµç¨‹

```
1. æ¯å‘¨/æ¯æœˆç”Ÿæˆä»»åŠ¡
   python testyd/pdd/generate_tasks.py --schedule weekly
   â†“
   åªæ›´æ–° kpi_weekly_status = 'å¾…æ‰§è¡Œ'
   å…¶ä»–å­—æ®µä¿æŒä¸å˜

2. æ‰§è¡Œå‘¨åº¦/æœˆåº¦çˆ¬è™«
   python testyd/pdd/pdd_kpi_weekly.py
```

## â• æ–°å¢çˆ¬è™«æ­¥éª¤

### ç¤ºä¾‹ï¼šæ–°å¢"åº—é“ºè¯„åˆ†"çˆ¬è™«

#### æ­¥éª¤1ï¼šæ·»åŠ é…ç½®

åœ¨ `crawler_config.py` ä¸­æ·»åŠ ï¼š

```python
CRAWLER_TASKS = {
    # ... ç°æœ‰é…ç½® ...
    
    'shop_rating': {
        'name': 'åº—é“ºè¯„åˆ†æ•°æ®é‡‡é›†',
        'script': 'pdd_shop_rating.py',
        'status_field': 'shop_rating_status',
        'schedule': 'daily',
        'date_offset': -1,
        'minio_path': 'ods/pdd/pdd_shop_rating',
        'dremio_table': 'minio.warehouse.ods.pdd.pdd_shop_rating',
        'enabled': True
    }
}
```

#### æ­¥éª¤2ï¼šæ·»åŠ æ•°æ®åº“å­—æ®µ

```sql
ALTER TABLE pdd_tasks 
ADD COLUMN shop_rating_status VARCHAR(20) DEFAULT NULL;
```

#### æ­¥éª¤3ï¼šåˆ›å»ºçˆ¬è™«è„šæœ¬

åˆ›å»º `testyd/pdd/pdd_shop_rating.py`ï¼š

```python
# -*- coding: utf-8 -*-
"""åº—é“ºè¯„åˆ†æ•°æ®é‡‡é›†"""
import sys
from datetime import datetime, timedelta
sys.path.append(r'D:\testyd\pdd')

from base_crawler import BaseCrawler
from crawler_config import CRAWLER_TASKS

class ShopRatingCrawler(BaseCrawler):
    """åº—é“ºè¯„åˆ†çˆ¬è™«"""
    
    def __init__(self):
        task_config = CRAWLER_TASKS['shop_rating']
        super().__init__('shop_rating', task_config)
        
        # è®¾ç½®ç›®æ ‡æ—¥æœŸ
        offset = task_config.get('date_offset', -1)
        self.target_date = (datetime.now() + timedelta(days=offset)).strftime('%Y-%m-%d')
    
    def process_shop(self, shop_name, cookie, **kwargs):
        """å¤„ç†å•ä¸ªåº—é“ºçš„æ•°æ®é‡‡é›†"""
        try:
            # 1. è°ƒç”¨APIè·å–åº—é“ºè¯„åˆ†æ•°æ®
            rating_data = self.fetch_rating_data(cookie)
            
            # 2. ä¿å­˜åˆ°Excel
            save_path = self.save_to_excel(rating_data, shop_name)
            
            return save_path
        except Exception as e:
            print(f'[é”™è¯¯] {shop_name} æ•°æ®é‡‡é›†å¤±è´¥: {e}')
            return None
    
    def fetch_rating_data(self, cookie):
        """è·å–åº—é“ºè¯„åˆ†æ•°æ®"""
        # TODO: å®ç°APIè°ƒç”¨é€»è¾‘
        pass
    
    def save_to_excel(self, data, shop_name):
        """ä¿å­˜æ•°æ®åˆ°Excel"""
        # TODO: å®ç°ä¿å­˜é€»è¾‘
        pass

if __name__ == '__main__':
    crawler = ShopRatingCrawler()
    crawler.run()
```

#### æ­¥éª¤4ï¼šæµ‹è¯•

```bash
# 1. ç”Ÿæˆä»»åŠ¡
python testyd/pdd/generate_tasks.py --schedule daily

# 2. æ‰§è¡Œçˆ¬è™«
python testyd/pdd/pdd_shop_rating.py

# 3. æ£€æŸ¥çŠ¶æ€
python testyd/check_task_status.py
```

**å®Œæˆï¼** æ— éœ€ä¿®æ”¹ä»»ä½•æ ¸å¿ƒä»£ç ï¼

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. é…ç½®é©±åŠ¨

- âœ… æ‰€æœ‰é…ç½®é›†ä¸­åœ¨ä¸€ä¸ªæ–‡ä»¶
- âœ… ä¿®æ”¹é…ç½®æ— éœ€æ”¹ä»£ç 
- âœ… æ˜“äºç»´æŠ¤å’Œç®¡ç†

### 2. ä»»åŠ¡ç‹¬ç«‹

- âœ… ä¸åŒä»»åŠ¡ç±»å‹ç‹¬ç«‹æ‰§è¡Œ
- âœ… æ—¥åº¦/å‘¨åº¦/æœˆåº¦ä»»åŠ¡äº’ä¸å½±å“
- âœ… å¤±è´¥ä»»åŠ¡å¯å•ç‹¬é‡è¯•

### 3. çŠ¶æ€æ¸…æ™°

- âœ… NULL = æ²¡æœ‰ä»»åŠ¡
- âœ… "å¾…æ‰§è¡Œ" = éœ€è¦æ‰§è¡Œ
- âœ… "å·²å®Œæˆ" = å·²å®Œæˆ
- âœ… é‡å¤ç”Ÿæˆä¸ä¼šé‡ç½®å·²å®ŒæˆçŠ¶æ€

### 4. æ˜“äºæ‰©å±•

- âœ… æ–°å¢çˆ¬è™«åªéœ€3æ­¥
- âœ… æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
- âœ… çœŸæ­£çš„"å³æ’å³ç”¨"

### 5. ä»£ç å¤ç”¨

- âœ… BaseCrawleræä¾›é€šç”¨åŠŸèƒ½
- âœ… å­ç±»åªéœ€å®ç°ä¸šåŠ¡é€»è¾‘
- âœ… å‡å°‘é‡å¤ä»£ç 

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### pdd_tasks è¡¨ç»“æ„

```sql
CREATE TABLE pdd_tasks (
    time_period VARCHAR(20) NOT NULL,           -- æ—¶é—´å‘¨æœŸ
    shop_name VARCHAR(100) NOT NULL,            -- åº—é“ºåç§°
    badsscore_status VARCHAR(20) DEFAULT NULL,  -- å·®è¯„æ•°æ®çŠ¶æ€
    quality_status VARCHAR(20) DEFAULT NULL,    -- äº§å“è´¨é‡çŠ¶æ€
    kpi_days_status VARCHAR(20) DEFAULT NULL,   -- å®¢æœç»©æ•ˆï¼ˆæ—¥åº¦ï¼‰çŠ¶æ€
    kpi_weekly_status VARCHAR(20) DEFAULT NULL, -- å®¢æœç»©æ•ˆï¼ˆå‘¨åº¦ï¼‰çŠ¶æ€
    kpi_monthly_status VARCHAR(20) DEFAULT NULL,-- å®¢æœç»©æ•ˆï¼ˆæœˆåº¦ï¼‰çŠ¶æ€
    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (time_period, shop_name)
);
```

### çŠ¶æ€å€¼è¯´æ˜

- **NULL** - æ²¡æœ‰ä»»åŠ¡ï¼ˆè¯¥åº—é“ºè¯¥æ—¥æœŸä¸éœ€è¦æ‰§è¡Œæ­¤ä»»åŠ¡ï¼‰
- **"å¾…æ‰§è¡Œ"** - æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œ
- **"å·²å®Œæˆ"** - ä»»åŠ¡å·²å®Œæˆ

## ğŸ” å…³é”®æŠ€æœ¯ç‚¹

### 1. INSERT ... ON DUPLICATE KEY UPDATE

```sql
INSERT INTO pdd_tasks (time_period, shop_name, badsscore_status) 
VALUES ('2025-10-02', '361å—å®ä¸“å–åº—', 'å¾…æ‰§è¡Œ')
ON DUPLICATE KEY UPDATE 
    badsscore_status = IF(badsscore_status IS NULL OR badsscore_status = '', 'å¾…æ‰§è¡Œ', badsscore_status)
```

**ä½œç”¨ï¼š**
- å¦‚æœè®°å½•ä¸å­˜åœ¨ï¼Œæ’å…¥æ–°è®°å½•
- å¦‚æœè®°å½•å·²å­˜åœ¨ï¼Œåªæ›´æ–°NULLå­—æ®µ
- å·²å®Œæˆçš„ä»»åŠ¡ä¸ä¼šè¢«é‡ç½®

### 2. åŠ¨æ€SQLæ„å»º

```python
# åªæ’å…¥æŒ‡å®šçš„ä»»åŠ¡å­—æ®µ
insert_columns = ['time_period', 'shop_name'] + available_columns
placeholders = ', '.join(['%s'] * len(insert_columns))

# åªæ›´æ–°æŒ‡å®šçš„ä»»åŠ¡å­—æ®µ
update_clauses = []
for col in available_columns:
    update_clauses.append(
        f"{col} = IF({col} IS NULL OR {col} = '', 'å¾…æ‰§è¡Œ', {col})"
    )
```

**ä¼˜åŠ¿ï¼š**
- çµæ´»æ”¯æŒä¸åŒä»»åŠ¡ç±»å‹
- ä¸åŒä»»åŠ¡å¯ç‹¬ç«‹æ›´æ–°
- é¿å…ç›¸äº’å½±å“

## ğŸ‰ æ€»ç»“

æ–°æ¶æ„å®Œç¾è§£å†³äº†ä½ æå‡ºçš„æ‰€æœ‰éœ€æ±‚ï¼š

1. âœ… **çŠ¶æ€åŒºåˆ†æ˜ç¡®**
   - NULL = æ²¡æœ‰ä»»åŠ¡
   - "å¾…æ‰§è¡Œ" = éœ€è¦æ‰§è¡Œ
   - "å·²å®Œæˆ" = å·²å®Œæˆ

2. âœ… **æ”¯æŒä¸åŒæ‰§è¡Œé¢‘ç‡**
   - æ—¥åº¦ä»»åŠ¡æ¯å¤©æ‰§è¡Œ
   - å‘¨åº¦ä»»åŠ¡æ¯å‘¨æ‰§è¡Œ
   - æœˆåº¦ä»»åŠ¡æ¯æœˆæ‰§è¡Œ

3. âœ… **æ˜“äºæ‰©å±•**
   - æ–°å¢çˆ¬è™«åªéœ€æ·»åŠ é…ç½®
   - æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
   - çœŸæ­£çš„"å³æ’å³ç”¨"

4. âœ… **ä»£ç å¤ç”¨**
   - BaseCrawleræä¾›é€šç”¨åŠŸèƒ½
   - å­ç±»åªéœ€å®ç°ä¸šåŠ¡é€»è¾‘
   - å¤§å¤§å‡å°‘é‡å¤ä»£ç 

5. âœ… **å¯ç»´æŠ¤æ€§å¼º**
   - é…ç½®é›†ä¸­ç®¡ç†
   - ç»“æ„æ¸…æ™°
   - æ˜“äºç†è§£å’Œç»´æŠ¤

**åç»­å¼€å‘æ–°çˆ¬è™«ï¼Œåªéœ€3æ­¥ï¼š**
1. åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ é…ç½®
2. åœ¨æ•°æ®åº“ä¸­æ·»åŠ å­—æ®µ
3. åˆ›å»ºç»§æ‰¿BaseCrawlerçš„è„šæœ¬

**çœŸæ­£å®ç°äº†"åŠ å›ºå®šæ¨¡å—å°±å¯ä»¥"çš„ç›®æ ‡ï¼** ğŸ¯

