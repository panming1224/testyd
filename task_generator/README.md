# ç»Ÿä¸€ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ

## ğŸ“‹ æ¦‚è¿°

**ç»Ÿä¸€ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ** - æ‰€æœ‰å¹³å°ï¼ˆæ‹¼å¤šå¤šã€å¤©çŒ«ç­‰ï¼‰çš„ä»»åŠ¡ç”Ÿæˆå’Œè°ƒåº¦é›†ä¸­ç®¡ç†ã€‚

### æ ¸å¿ƒç‰¹æ€§

âœ… **ç»Ÿä¸€ä»»åŠ¡ç”Ÿæˆ** - æ‰€æœ‰å¹³å°ä»»åŠ¡é…ç½®é›†ä¸­ç®¡ç†
âœ… **ç»Ÿä¸€ä»»åŠ¡è°ƒåº¦** - æ‰€æœ‰å¹³å°ä»»åŠ¡ç»Ÿä¸€è°ƒåº¦æ‰§è¡Œ
âœ… **è‡ªåŠ¨åŒ–è¿è¡Œ** - åå°è¿è¡Œï¼Œä¸å ç”¨ç»ˆç«¯
âœ… **æ˜“äºæ‰©å±•** - æ–°å¢å¹³å°æˆ–ä»»åŠ¡åªéœ€æ·»åŠ é…ç½®
âœ… **çµæ´»è°ƒåº¦** - æ”¯æŒæ—¥åº¦ã€å‘¨åº¦ã€æœˆåº¦ä»»åŠ¡
âœ… **å¯è§†åŒ–ç›‘æ§** - Webç•Œé¢å®æ—¶æŸ¥çœ‹ä»»åŠ¡çŠ¶æ€

---

## ğŸ“ æ–‡ä»¶ç»“æ„

```
task_generator/
â”œâ”€â”€ README.md                      # æœ¬æ–‡æ¡£
â”œâ”€â”€ platform_config.py             # å¹³å°ä»»åŠ¡é…ç½®ï¼ˆæ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼‰
â”œâ”€â”€ generate_all_tasks.py          # ç»Ÿä¸€ä»»åŠ¡ç”Ÿæˆå™¨
â”œâ”€â”€ scheduler_manager.py           # è°ƒåº¦æœåŠ¡ç®¡ç†å™¨
â”œâ”€â”€ scheduler_config.py            # è°ƒåº¦é…ç½®
â”œâ”€â”€ scheduler_flows.py             # å·¥ä½œæµå®šä¹‰
â”œâ”€â”€ è°ƒåº¦ç³»ç»Ÿæ–‡æ¡£.md                 # è°ƒåº¦ç³»ç»Ÿè¯¦ç»†æ–‡æ¡£
â”œâ”€â”€ README_è°ƒåº¦ç³»ç»Ÿ.md              # è°ƒåº¦ç³»ç»Ÿå¿«é€Ÿå¼€å§‹
â””â”€â”€ scheduler.log                  # è°ƒåº¦æ—¥å¿—æ–‡ä»¶
```

---

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### ä¸€ã€è°ƒåº¦æœåŠ¡ç®¡ç†

#### 1. å¯åŠ¨è°ƒåº¦æœåŠ¡

```bash
cd D:\testyd\task_generator
python scheduler_manager.py start
```

æœåŠ¡å¯åŠ¨åä¼šï¼š
- âœ… è‡ªåŠ¨å¯åŠ¨PrefectæœåŠ¡å™¨
- âœ… è‡ªåŠ¨å¯åŠ¨ä»»åŠ¡è°ƒåº¦å™¨
- âœ… åå°è¿è¡Œï¼Œä¸å ç”¨ç»ˆç«¯
- âœ… æŒ‰é…ç½®çš„æ—¶é—´è‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰ä»»åŠ¡

#### 2. æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
python scheduler_manager.py status
```

#### 3. åœæ­¢æœåŠ¡

```bash
python scheduler_manager.py stop
```

#### 4. é‡å¯æœåŠ¡

```bash
python scheduler_manager.py restart
```

#### 5. è®¿é—®Webç›‘æ§ç•Œé¢

æµè§ˆå™¨æ‰“å¼€: http://127.0.0.1:4200

---

### äºŒã€æ‰‹åŠ¨ç”Ÿæˆä»»åŠ¡ï¼ˆæµ‹è¯•ç”¨ï¼‰

#### 1. ç”Ÿæˆæ¯æ—¥ä»»åŠ¡ï¼ˆæ‰€æœ‰å¹³å°ï¼‰

```bash
cd D:\testyd\task_generator
python generate_all_tasks.py --schedule daily
```

#### 2. ç”Ÿæˆå‘¨åº¦ä»»åŠ¡ï¼ˆæ‰€æœ‰å¹³å°ï¼‰

```bash
python generate_all_tasks.py --schedule weekly
```

#### 3. ç”Ÿæˆæœˆåº¦ä»»åŠ¡ï¼ˆæ‰€æœ‰å¹³å°ï¼‰

```bash
python generate_all_tasks.py --schedule monthly
```

#### 4. ç”Ÿæˆæ‰€æœ‰ç±»å‹ä»»åŠ¡

```bash
python generate_all_tasks.py --schedule all
```

#### 5. åªä¸ºæŒ‡å®šå¹³å°ç”Ÿæˆä»»åŠ¡

```bash
# åªä¸ºæ‹¼å¤šå¤šç”Ÿæˆä»»åŠ¡
python generate_all_tasks.py --schedule daily --platforms pdd

# åªä¸ºå¤©çŒ«ç”Ÿæˆä»»åŠ¡
python generate_all_tasks.py --schedule daily --platforms tm

# ä¸ºæ‹¼å¤šå¤šå’Œå¤©çŒ«ç”Ÿæˆä»»åŠ¡
python generate_all_tasks.py --schedule daily --platforms pdd tm
```

#### 6. æµ‹è¯•æ¨¡å¼ï¼ˆæŒ‡å®šæ—¥æœŸï¼‰

```bash
python generate_all_tasks.py --schedule daily --date 2025-10-02
```

---

## ğŸ“Š è‡ªåŠ¨è°ƒåº¦æ—¶é—´è¡¨

### ä»»åŠ¡ç”Ÿæˆ

| ä»»åŠ¡ç±»å‹ | æ‰§è¡Œæ—¶é—´ | Cronè¡¨è¾¾å¼ | è¯´æ˜ |
|---------|---------|-----------|------|
| æ¯æ—¥ä»»åŠ¡ç”Ÿæˆ | æ¯å¤©00:05 | `5 0 * * *` | ä¸ºæ‰€æœ‰å¹³å°ç”Ÿæˆæ¯æ—¥ä»»åŠ¡ |
| æ¯å‘¨ä»»åŠ¡ç”Ÿæˆ | æ¯å‘¨å…­00:10 | `10 0 * * 6` | ä¸ºæ‰€æœ‰å¹³å°ç”Ÿæˆå‘¨åº¦ä»»åŠ¡ |
| æ¯æœˆä»»åŠ¡ç”Ÿæˆ | æ¯æœˆ1å·00:15 | `15 0 1 * *` | ä¸ºæ‰€æœ‰å¹³å°ç”Ÿæˆæœˆåº¦ä»»åŠ¡ |

### ä»»åŠ¡æ‰§è¡Œ

| ä»»åŠ¡ | æ‰§è¡Œæ—¶é—´ | è¯´æ˜ |
|------|---------|------|
| ERPé—¨åº—æ•°æ® | æ¯å¤©07:00 | æ‹‰å–ERPé—¨åº—æ•°æ® |
| äº¬ä¸œé—¨åº—æ•°æ® | æ¯å¤©07:30 | æ‹‰å–äº¬ä¸œé—¨åº—æ•°æ® |
| PDDè´¨é‡æ•°æ® | æ¯å¤©08:00 | æ‹‰å–PDDè´¨é‡æ•°æ® |
| PDDå·®è¯„æ•°æ® | æ¯å¤©08:30 | æ‹‰å–PDDå·®è¯„æ•°æ® |
| PDDKPIæ•°æ® | æ¯å¤©11:00 | æ‹‰å–PDDKPIæ•°æ® |
| PDDKPIå‘¨æŠ¥ | æ¯å‘¨å…­12:00 | æ‹‰å–PDDKPIå‘¨æŠ¥ |
| PDDKPIæœˆæŠ¥ | æ¯æœˆ3å·12:30 | æ‹‰å–PDDKPIæœˆæŠ¥ |

---

## ğŸ“Š å½“å‰æ”¯æŒçš„å¹³å°

| å¹³å° | å¹³å°ä»£ç  | åº—é“ºè¡¨ | ä»»åŠ¡è¡¨ |
|------|---------|--------|--------|
| æ‹¼å¤šå¤š | pdd | pdd_shops | pdd_tasks |
| å¤©çŒ« | tm | tm_shops | tm_tasks |

---

## ğŸ“‹ ä»»åŠ¡é…ç½®è¯´æ˜

### æ‹¼å¤šå¤šä»»åŠ¡

| ä»»åŠ¡ç±»å‹ | è°ƒåº¦ç±»å‹ | æ—¥æœŸåç§» | çŠ¶æ€å­—æ®µ | è¯´æ˜ |
|---------|---------|---------|---------|------|
| badscore | daily | T-1 | badsscore_status | å·®è¯„æ•°æ® |
| quality | daily | T | quality_status | äº§å“è´¨é‡ |
| kpi_days | daily | T-3 | kpi_days_status | å®¢æœç»©æ•ˆï¼ˆæ—¥åº¦ï¼‰ |
| chat | daily | T-1 | chat_status | èŠå¤©è®°å½• |
| kpi_weekly | weekly | T-9~T-3 | kpi_weekly_status | å®¢æœç»©æ•ˆï¼ˆå‘¨åº¦ï¼‰ |
| kpi_monthly | monthly | ä¸Šæœˆ | kpi_monthly_status | å®¢æœç»©æ•ˆï¼ˆæœˆåº¦ï¼‰ |

### å¤©çŒ«ä»»åŠ¡

| ä»»åŠ¡ç±»å‹ | è°ƒåº¦ç±»å‹ | æ—¥æœŸåç§» | çŠ¶æ€å­—æ®µ | è¯´æ˜ |
|---------|---------|---------|---------|------|
| badscore | daily | T-1 | badscore_status | å·®è¯„æ•°æ® |
| chat | daily | T-1 | chat_status | èŠå¤©è®°å½• |
| kpi_self | daily | T-4 | kpi_self_status | å®¢æœç»©æ•ˆè‡ªåˆ¶æŠ¥è¡¨ |
| kpi_official | daily | T-4 | kpi_official_status | å®¢æœç»©æ•ˆå®˜æ–¹æŠ¥è¡¨ |
| kpi_weekly | weekly | T-9~T-3 | kpi_weekly_status | å®¢æœç»©æ•ˆï¼ˆå‘¨åº¦ï¼‰ |
| kpi_monthly | monthly | ä¸Šæœˆ | kpi_monthly_status | å®¢æœç»©æ•ˆï¼ˆæœˆåº¦ï¼‰ |

---

## â• æ–°å¢å¹³å°æŒ‡å—

### æ­¥éª¤1ï¼šåœ¨ `platform_config.py` æ·»åŠ å¹³å°é…ç½®

```python
# æ–°å¹³å°ä»»åŠ¡é…ç½®
NEW_PLATFORM_TASKS = {
    'task1': {
        'name': 'ä»»åŠ¡1åç§°',
        'script': 'new_platform/task1.py',
        'status_field': 'task1_status',
        'schedule': 'daily',
        'date_offset': -1,
        'minio_path': 'ods/new_platform/task1',
        'dremio_table': 'minio.warehouse.ods.new_platform.task1',
        'enabled': True
    }
}

# æ·»åŠ åˆ°å¹³å°æ•°æ®åº“é…ç½®
PLATFORM_DB_CONFIG['new_platform'] = {
    'platform': 'new_platform',
    'shops_table': 'new_platform_shops',
    'tasks_table': 'new_platform_tasks',
    'database': 'company'
}

# æ·»åŠ åˆ°æ‰€æœ‰å¹³å°é…ç½®
ALL_PLATFORMS['new_platform'] = {
    'name': 'æ–°å¹³å°',
    'tasks': NEW_PLATFORM_TASKS,
    'db_config': PLATFORM_DB_CONFIG['new_platform']
}
```

### æ­¥éª¤2ï¼šæµ‹è¯•

```bash
python generate_all_tasks.py --schedule daily --platforms new_platform
```

### æ­¥éª¤3ï¼šå®Œæˆï¼

æ–°å¹³å°å·²æ·»åŠ åˆ°ç»Ÿä¸€ä»»åŠ¡ç”Ÿæˆç³»ç»Ÿä¸­ï¼

---

## â• æ–°å¢ä»»åŠ¡æŒ‡å—

### ä¸ºç°æœ‰å¹³å°æ·»åŠ æ–°ä»»åŠ¡

åœ¨ `platform_config.py` ä¸­æ‰¾åˆ°å¯¹åº”å¹³å°çš„ä»»åŠ¡é…ç½®ï¼Œæ·»åŠ æ–°ä»»åŠ¡ï¼š

```python
PDD_TASKS['new_task'] = {
    'name': 'æ–°ä»»åŠ¡åç§°',
    'script': 'pdd/pdd_new_task.py',
    'status_field': 'new_task_status',
    'schedule': 'daily',
    'date_offset': -1,
    'minio_path': 'ods/pdd/pdd_new_task',
    'dremio_table': 'minio.warehouse.ods.pdd.pdd_new_task',
    'enabled': True
}
```

**æ³¨æ„äº‹é¡¹ï¼š**
1. `status_field` å¿…é¡»åœ¨æ•°æ®åº“ä»»åŠ¡è¡¨ä¸­å­˜åœ¨
2. `date_offset` ä¸ºè´Ÿæ•°è¡¨ç¤ºè¿‡å»çš„æ—¥æœŸï¼ˆT-1è¡¨ç¤ºæ˜¨å¤©ï¼‰
3. `schedule` æ”¯æŒ 'daily'ã€'weekly'ã€'monthly'
4. å‘¨åº¦ä»»åŠ¡ä½¿ç”¨ `date_range` è€Œä¸æ˜¯ `date_offset`
5. æœˆåº¦ä»»åŠ¡ä½¿ç”¨ `date_range: 'last_month'`

---

## ğŸ”§ é…ç½®æ–‡ä»¶è¯¦è§£

### platform_config.py

**æ ¸å¿ƒé…ç½®æ–‡ä»¶**ï¼ŒåŒ…å«ï¼š

1. **ä»»åŠ¡é…ç½®** - æ¯ä¸ªå¹³å°çš„æ‰€æœ‰ä»»åŠ¡é…ç½®
2. **æ•°æ®åº“é…ç½®** - æ¯ä¸ªå¹³å°çš„æ•°æ®åº“è¿æ¥é…ç½®
3. **è¾…åŠ©å‡½æ•°** - è·å–é…ç½®ã€è®¡ç®—æ—¥æœŸç­‰å·¥å…·å‡½æ•°

**ä»»åŠ¡é…ç½®å­—æ®µè¯´æ˜ï¼š**

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| name | str | âœ… | ä»»åŠ¡æ˜¾ç¤ºåç§° |
| script | str | âœ… | è„šæœ¬è·¯å¾„ï¼ˆç›¸å¯¹äºtestydç›®å½•ï¼‰ |
| status_field | str | âœ… | æ•°æ®åº“çŠ¶æ€å­—æ®µå |
| schedule | str | âœ… | è°ƒåº¦ç±»å‹ï¼šdaily/weekly/monthly |
| date_offset | int | âš ï¸ | æ—¥æœŸåç§»ï¼ˆdailyä»»åŠ¡å¿…å¡«ï¼‰ |
| date_range | tuple/str | âš ï¸ | æ—¥æœŸèŒƒå›´ï¼ˆweekly/monthlyä»»åŠ¡å¿…å¡«ï¼‰ |
| minio_path | str | âŒ | MinIOå­˜å‚¨è·¯å¾„ |
| dremio_table | str | âŒ | Dremioè¡¨å |
| enabled | bool | âŒ | æ˜¯å¦å¯ç”¨ï¼ˆé»˜è®¤Trueï¼‰ |

---

## ğŸ“Š æ‰§è¡Œæµç¨‹

```
1. è¯»å–å¹³å°é…ç½®
   â†“
2. ç­›é€‰æŒ‡å®šè°ƒåº¦ç±»å‹çš„ä»»åŠ¡
   â†“
3. éå†æ¯ä¸ªå¹³å°
   â†“
4. ä¸ºæ¯ä¸ªå¹³å°çš„æ¯ä¸ªä»»åŠ¡ï¼š
   - è®¡ç®—ç›®æ ‡æ—¥æœŸ
   - è¿æ¥æ•°æ®åº“
   - ç”Ÿæˆä»»åŠ¡è®°å½•
   - æ›´æ–°çŠ¶æ€ä¸º"å¾…æ‰§è¡Œ"
   â†“
5. æ‰“å°æ‰§è¡Œæ‘˜è¦
```

---

## ğŸ” æ—¥æœŸè®¡ç®—è§„åˆ™

### æ—¥åº¦ä»»åŠ¡ï¼ˆdailyï¼‰

ä½¿ç”¨ `date_offset` å­—æ®µï¼š
- `date_offset: 0` â†’ ä»Šå¤©ï¼ˆTï¼‰
- `date_offset: -1` â†’ æ˜¨å¤©ï¼ˆT-1ï¼‰
- `date_offset: -3` â†’ 3å¤©å‰ï¼ˆT-3ï¼‰

### å‘¨åº¦ä»»åŠ¡ï¼ˆweeklyï¼‰

ä½¿ç”¨ `date_range` å­—æ®µï¼š
- `date_range: (-9, -3)` â†’ T-9 åˆ° T-3ï¼ˆ7å¤©ï¼‰
- è¿”å›æ ¼å¼ï¼š`2025-09-24_2025-09-30`

### æœˆåº¦ä»»åŠ¡ï¼ˆmonthlyï¼‰

ä½¿ç”¨ `date_range: 'last_month'`ï¼š
- è‡ªåŠ¨è®¡ç®—ä¸Šä¸ªæœˆ
- è¿”å›æ ¼å¼ï¼š`2025-09`

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šæ¯å¤©å‡Œæ™¨è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰å¹³å°çš„æ—¥åº¦ä»»åŠ¡

```bash
# åœ¨è°ƒåº¦ç³»ç»Ÿä¸­é…ç½®
python generate_all_tasks.py --schedule daily
```

### ç¤ºä¾‹2ï¼šæ¯å‘¨å…­ç”Ÿæˆæ‰€æœ‰å¹³å°çš„å‘¨åº¦ä»»åŠ¡

```bash
python generate_all_tasks.py --schedule weekly
```

### ç¤ºä¾‹3ï¼šæ¯æœˆ3å·ç”Ÿæˆæ‰€æœ‰å¹³å°çš„æœˆåº¦ä»»åŠ¡

```bash
python generate_all_tasks.py --schedule monthly
```

### ç¤ºä¾‹4ï¼šæµ‹è¯•æŸä¸ªæ—¥æœŸçš„ä»»åŠ¡ç”Ÿæˆ

```bash
python generate_all_tasks.py --schedule daily --date 2025-10-02
```

---

## ğŸ”— ä¸è°ƒåº¦ç³»ç»Ÿé›†æˆ

åœ¨ `scheduler_config.py` ä¸­é…ç½®ï¼š

```python
{
    'flow': unified_task_generation_flow,
    'name': 'ç»Ÿä¸€ä»»åŠ¡ç”Ÿæˆ-å®šæ—¶æ‰§è¡Œ',
    'cron': '5 0 * * *',  # æ¯å¤©00:05
    'description': 'æ¯å¤©00:05ä¸ºæ‰€æœ‰å¹³å°ç”Ÿæˆå¾…æ‰§è¡Œä»»åŠ¡',
    'tags': ['ä»»åŠ¡ç”Ÿæˆ', 'å®šæ—¶'],
    'enabled': True
}
```

---

## âš ï¸ é‡è¦è¯´æ˜

1. **ä»»åŠ¡ç”Ÿæˆä¸ä¼šé‡å¤** - ä½¿ç”¨ `INSERT IGNORE` æœºåˆ¶ï¼Œç›¸åŒæ—¥æœŸçš„ä»»åŠ¡ä¸ä¼šé‡å¤ç”Ÿæˆ
2. **çŠ¶æ€å­—æ®µå¿…é¡»å­˜åœ¨** - ç¡®ä¿æ•°æ®åº“ä»»åŠ¡è¡¨ä¸­æœ‰å¯¹åº”çš„çŠ¶æ€å­—æ®µ
3. **æ—¥æœŸè®¡ç®—è‡ªåŠ¨** - æ ¹æ®é…ç½®è‡ªåŠ¨è®¡ç®—ç›®æ ‡æ—¥æœŸï¼Œæ— éœ€æ‰‹åŠ¨æŒ‡å®š
4. **å¹³å°ç‹¬ç«‹** - æ¯ä¸ªå¹³å°ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“è¡¨ï¼Œäº’ä¸å½±å“

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

**ç›¸å…³æ–‡æ¡£ï¼š**
- è°ƒåº¦ç³»ç»Ÿæ–‡æ¡£: `testyd/è°ƒåº¦ç³»ç»Ÿæ–‡æ¡£.md`
- PDDæ¶æ„æ–‡æ¡£: `testyd/pdd/æ¶æ„æ–‡æ¡£.md`
- TMæ¶æ„æ–‡æ¡£: `testyd/tm/æ¶æ„æ–‡æ¡£.md`

**å¸¸è§é—®é¢˜ï¼š**

Q: å¦‚ä½•æŸ¥çœ‹ç”Ÿæˆäº†å“ªäº›ä»»åŠ¡ï¼Ÿ  
A: æŸ¥çœ‹æ•°æ®åº“å¯¹åº”å¹³å°çš„ä»»åŠ¡è¡¨ï¼ŒçŠ¶æ€ä¸º"å¾…æ‰§è¡Œ"çš„å³ä¸ºæ–°ç”Ÿæˆçš„ä»»åŠ¡ã€‚

Q: ä»»åŠ¡ç”Ÿæˆå¤±è´¥æ€ä¹ˆåŠï¼Ÿ  
A: æ£€æŸ¥æ•°æ®åº“è¿æ¥ã€çŠ¶æ€å­—æ®µæ˜¯å¦å­˜åœ¨ã€é…ç½®æ˜¯å¦æ­£ç¡®ã€‚

Q: å¦‚ä½•ç¦ç”¨æŸä¸ªä»»åŠ¡ï¼Ÿ  
A: åœ¨é…ç½®ä¸­è®¾ç½® `'enabled': False`ã€‚

---

**ç»´æŠ¤è€…ï¼š** AI Assistant  
**æœ€åæ›´æ–°ï¼š** 2025-10-04  
**ç‰ˆæœ¬ï¼š** 1.0.0

