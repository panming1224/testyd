# 任务调度系统 - 架构文档

## 📋 文档说明

**本文档目的：**
- 快速了解调度系统功能和使用方式
- 新增任务时的操作指南
- 维护和故障排查

**最后更新：** 2025-10-03

---

## 🏗️ 系统架构

### 核心组件

```
┌─────────────────────────────────────────────────────────┐
│              scheduler_manager.py                        │
│         服务管理器 - 启动/停止/状态检查                    │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│              scheduler_config.py                         │
│         调度配置 - 定义所有定时任务                        │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│              scheduler_flows.py                          │
│         工作流定义 - 封装各个任务的执行逻辑                 │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│              Prefect Server                              │
│         调度引擎 - 执行定时任务                            │
└─────────────────────────────────────────────────────────┘
```

---

## 📁 文件说明

### 1. scheduler_manager.py - 服务管理器

**功能：** 管理调度服务的生命周期

**命令：**
```bash
# 启动服务（后台运行）
python scheduler_manager.py start

# 停止服务
python scheduler_manager.py stop

# 查看状态
python scheduler_manager.py status

# 重启服务
python scheduler_manager.py restart
```

**特点：**
- ✅ 真正的后台运行，不占用终端
- ✅ 关闭终端窗口不影响服务
- ✅ 自动检测服务状态
- ✅ 优雅停止所有进程

---

### 2. scheduler_config.py - 调度配置

**功能：** 集中管理所有定时任务配置

**配置结构：**
```python
TASK_CONFIGS = [
    {
        'flow': task_flow_function,      # 工作流函数
        'name': '任务名称',               # 显示名称
        'cron': '0 8 * * *',             # Cron表达式
        'description': '任务描述',        # 详细说明
        'tags': ['标签1', '标签2'],      # 任务标签
        'enabled': True                  # 是否启用
    }
]
```

**当前配置的任务：**

| 序号 | 任务名称 | 执行时间 | Cron表达式 | 状态 |
|------|---------|---------|-----------|------|
| 1 | 统一任务生成-每日 | 每天00:05 | `5 0 * * *` | ✅ 启用 |
| 2 | 统一任务生成-每周 | 每周六00:10 | `10 0 * * 6` | ✅ 启用 |
| 3 | 统一任务生成-每月 | 每月1号00:15 | `15 0 1 * *` | ✅ 启用 |
| 4 | ERP门店数据 | 每天07:00 | `0 7 * * *` | ✅ 启用 |
| 5 | 京东门店数据 | 每天07:30 | `30 7 * * *` | ✅ 启用 |
| 6 | PDD质量数据 | 每天08:00 | `0 8 * * *` | ✅ 启用 |
| 7 | PDD差评数据 | 每天08:30 | `30 8 * * *` | ✅ 启用 |
| 8 | PDD聊天数据 | 每天09:00 | `0 9 * * *` | ⏸️ 待实现 |
| 9 | PDDKPI数据 | 每天11:00 | `0 11 * * *` | ✅ 启用 |
| 10 | PDDKPI周报 | 每周六12:00 | `0 12 * * 6` | ✅ 启用 |
| 11 | PDDKPI月报 | 每月3号12:30 | `30 12 3 * *` | ✅ 启用 |

---

### 3. scheduler_flows.py - 工作流定义

**功能：** 封装各个任务的执行逻辑

**核心函数：**

#### execute_script()
执行Python脚本的通用函数

```python
@task(name="执行脚本", retries=2, retry_delay_seconds=300)
def execute_script(
    script_path: str,    # 脚本路径
    task_name: str,      # 任务名称
    timeout: int = 3600, # 超时时间（秒）
    cwd: str = None      # 工作目录
):
    """执行Python脚本任务"""
    # ... 执行逻辑 ...
```

**特点：**
- ✅ 自动重试（失败后5分钟重试，最多2次）
- ✅ 超时控制（默认1小时）
- ✅ UTF-8编码支持
- ✅ 详细日志记录

#### 工作流示例
```python
@flow(name="PDD质量数据流")
def pdd_quality_flow():
    """PDD质量数据拉取流程"""
    logger = get_run_logger()
    logger.info("开始执行PDD质量数据拉取任务")
    
    result = execute_script(
        "pdd/pdd_quality.py",
        "PDD质量数据拉取",
        timeout=3600
    )
    
    return result
```

---

## 🚀 使用指南

### 启动调度系统

```bash
# 1. 进入工作目录
cd D:\testyd

# 2. 启动服务
python scheduler_manager.py start

# 3. 查看状态
python scheduler_manager.py status

# 4. 访问可视化界面
# 浏览器打开: http://127.0.0.1:4200
```

### 停止调度系统

```bash
python scheduler_manager.py stop
```

### 重启调度系统

```bash
python scheduler_manager.py restart
```

---

## ➕ 新增任务指南

### 步骤1：创建工作流

在 `scheduler_flows.py` 中添加新的工作流：

```python
@flow(name="新任务数据流")
def new_task_flow():
    """新任务数据拉取流程"""
    logger = get_run_logger()
    logger.info("开始执行新任务数据拉取")
    
    result = execute_script(
        "path/to/new_task.py",  # 脚本路径
        "新任务数据拉取",         # 任务名称
        timeout=3600            # 超时时间
    )
    
    if result:
        logger.info("新任务数据拉取完成")
    else:
        logger.error("新任务数据拉取失败")
    
    return result
```

### 步骤2：添加配置

在 `scheduler_config.py` 的 `TASK_CONFIGS` 中添加配置：

```python
TASK_CONFIGS = [
    # ... 现有配置 ...
    
    {
        'flow': new_task_flow,
        'name': '新任务-定时执行',
        'cron': '0 10 * * *',  # 每天10:00执行
        'description': '每天10:00执行新任务数据拉取',
        'tags': ['新任务', '定时'],
        'enabled': True
    }
]
```

### 步骤3：导入工作流

在 `scheduler_config.py` 顶部导入新的工作流：

```python
from scheduler_flows import (
    # ... 现有导入 ...
    new_task_flow  # 添加新的工作流
)
```

### 步骤4：重启服务

```bash
python scheduler_manager.py restart
```

**完成！** 新任务已添加到调度系统中！

---

## 📊 Cron表达式说明

### 格式
```
* * * * *
│ │ │ │ │
│ │ │ │ └─── 星期几 (0-7, 0和7都表示周日)
│ │ │ └───── 月份 (1-12)
│ │ └─────── 日期 (1-31)
│ └───────── 小时 (0-23)
└─────────── 分钟 (0-59)
```

### 常用示例

| 表达式 | 说明 |
|--------|------|
| `0 8 * * *` | 每天08:00 |
| `30 8 * * *` | 每天08:30 |
| `0 */2 * * *` | 每2小时执行一次 |
| `0 8 * * 1` | 每周一08:00 |
| `0 8 * * 6` | 每周六08:00 |
| `0 8 1 * *` | 每月1号08:00 |
| `0 8 1,15 * *` | 每月1号和15号08:00 |
| `*/5 * * * *` | 每5分钟执行一次 |

---

## 🔍 监控和日志

### 可视化界面

访问 `http://127.0.0.1:4200` 查看：
- 任务执行历史
- 任务执行状态
- 任务执行日志
- 任务调度计划

### 日志文件

**位置：** `D:\testyd\scheduler.log`

**内容：**
- 任务启动/停止记录
- 任务执行成功/失败记录
- 错误详情和堆栈跟踪

**查看日志：**
```bash
# Windows
type D:\testyd\scheduler.log

# 查看最后100行
powershell -command "Get-Content D:\testyd\scheduler.log -Tail 100"
```

---

## 🛠️ 故障排查

### 问题1：服务启动失败

**症状：** 运行 `start` 命令后服务未启动

**排查步骤：**
1. 检查端口4200是否被占用
   ```bash
   netstat -ano | findstr :4200
   ```
2. 检查Python环境是否正确
   ```bash
   python --version
   pip list | findstr prefect
   ```
3. 查看日志文件
   ```bash
   type D:\testyd\scheduler.log
   ```

**解决方案：**
- 如果端口被占用，停止占用进程或更改端口
- 如果Prefect未安装，运行 `pip install prefect`

---

### 问题2：任务未按时执行

**症状：** 任务没有在预定时间执行

**排查步骤：**
1. 检查服务状态
   ```bash
   python scheduler_manager.py status
   ```
2. 检查任务配置中的 `enabled` 是否为 `True`
3. 检查Cron表达式是否正确
4. 查看Prefect UI中的任务调度计划

**解决方案：**
- 确保服务正在运行
- 确保任务已启用
- 修正Cron表达式
- 重启服务

---

### 问题3：任务执行失败

**症状：** 任务执行但返回失败状态

**排查步骤：**
1. 查看Prefect UI中的任务日志
2. 查看 `scheduler.log` 文件
3. 手动运行脚本测试
   ```bash
   python pdd/pdd_quality.py
   ```

**解决方案：**
- 根据错误日志修复脚本问题
- 检查数据库连接
- 检查文件路径
- 检查网络连接

---

## 📝 维护建议

### 日常维护

1. **定期检查服务状态**
   ```bash
   python scheduler_manager.py status
   ```

2. **定期查看日志**
   - 检查是否有错误
   - 检查任务执行时间
   - 检查资源使用情况

3. **定期清理日志**
   ```bash
   # 备份日志
   copy D:\testyd\scheduler.log D:\testyd\scheduler_backup.log
   
   # 清空日志
   echo. > D:\testyd\scheduler.log
   ```

### 性能优化

1. **调整任务执行时间**
   - 避免多个任务同时执行
   - 合理分配任务执行时间
   - 考虑系统资源使用情况

2. **调整超时时间**
   - 根据实际执行时间调整
   - 避免设置过长的超时时间

3. **调整重试策略**
   - 根据任务特点调整重试次数
   - 调整重试延迟时间

---

## 🔐 安全建议

1. **限制访问**
   - Prefect UI默认只监听本地（127.0.0.1）
   - 如需远程访问，配置防火墙规则

2. **日志安全**
   - 不要在日志中记录敏感信息（密码、Token等）
   - 定期清理日志文件

3. **权限控制**
   - 确保脚本文件权限正确
   - 确保数据目录权限正确

---

## 📚 相关文档

- `testyd/pdd/架构文档.md` - PDD爬虫系统架构文档
- Prefect官方文档: https://docs.prefect.io/

---

## 📅 更新日志

### 2025-10-03
- ✅ 创建新的调度系统
- ✅ 整合PDD所有任务
- ✅ 整合ERP和京东任务
- ✅ 支持后台运行
- ✅ 支持服务管理

---

**维护者：** AI Assistant  
**最后更新：** 2025-10-03

